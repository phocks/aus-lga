<!DOCTYPE html>
<html>
<head>
    <title>Australian LGA</title>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>

    <link rel='stylesheet' href='http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css' />
    <link rel='stylesheet' href='style.css' />

    <script src='//cdn.leafletjs.com/leaflet-0.6.4/leaflet.js'></script>
    <script src='//code.jquery.com/jquery-2.0.3.min.js'></script>
</head>
<body>
    <div id='map'></div>

    <script>
      var cloudmadeUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/22677/256/{z}/{x}/{y}.png'
          cloudmadeAttribution = 'Map data &copy; 2013 OpenStreetMap contributors, Imagery &copy; 2013 CloudMade',
          cloudmade = L.tileLayer(cloudmadeUrl, { 
            maxZoom: 18,
            attribution: cloudmadeAttribution, 
            styleId: 22677
            }),
          map = L.map('map', {zoom: 6, layers: [cloudmade]});
          geoData = $.getJSON('AUS_LGA.json'),
          nswData = $.getJSON('nsw.json'),
          vicData = $.getJSON('vic.json'),
          qldData = $.getJSON('qld.json'),
          saData = $.getJSON('sa.json'),
          waData = $.getJSON('wa.json'),
          tasData = $.getJSON('tas.json'),
          ntData = $.getJSON('nt.json'),
          stateData = $.getJSON('states.json');

      $.when( geoData, nswData, vicData, qldData, saData, waData, tasData, ntData, stateData )
      .done( function( geoJSON, nswJSON, vicJSON, qldJSON, saJSON, waJSON, tasJSON, ntJSON, stateJSON ) {
        
        // horrible
        nswJSON[0].forEach(function(l) { 
          geoJSON[0].features.forEach(function(g) {
            if( g.properties.LGA_CODE11 == l.id ) {
              g.properties.data = l;
            }
          });
        });

        vicJSON[0].forEach(function(l) {
          geoJSON[0].features.forEach(function(g) {
            if( g.properties.LGA_CODE11 == l.id ) {
              g.properties.data = l;
            }
          });
        });

        qldJSON[0].forEach(function(l) {
          geoJSON[0].features.forEach(function(g) {
            if( g.properties.LGA_CODE11 == l.id ) {
              g.properties.data = l;
            }
          });
        });

        saJSON[0].forEach(function(l) {
          geoJSON[0].features.forEach(function(g) {
            if( g.properties.LGA_CODE11 == l.id ) {
              g.properties.data = l;
            }
          });
        });

        waJSON[0].forEach(function(l) {
          geoJSON[0].features.forEach(function(g) {
            if( g.properties.LGA_CODE11 == l.id ) {
              g.properties.data = l;
            }
          });
        });

        tasJSON[0].forEach(function(l) {
          geoJSON[0].features.forEach(function(g) {
            if( g.properties.LGA_CODE11 == l.id ) {
              g.properties.data = l;
            }
          });
        });

        ntJSON[0].forEach(function(l) {
          geoJSON[0].features.forEach(function(g) {
            if( g.properties.LGA_CODE11 == l.id ) {
              g.properties.data = l;
            }
          });
        });

        function getColor(d) {
          return d > 1000 ? '#800026' :
                 d > 500  ? '#BD0026' :
                 d > 200  ? '#E31A1C' :
                 d > 100  ? '#FC4E2A' :
                 d > 50   ? '#FD8D3C' :
                 d > 20   ? '#FEB24C' :
                 d > 10   ? '#FED976' :
                            '#FFEDA0';
        }

        function styleFeature(feature) {
          var density = feature.properties.data && feature.properties.data.density ? 
                feature.properties.data.density : 0;

          return {
              fillColor: getColor(density),
              weight: 1,
              opacity: 0.7,
              color: '#999',
              dashArray: '3',
              fillOpacity: 0.7
          };
        }

        L.geoJson(stateJSON[0], {
          style: {
            fillColor: 'transparent',
            fillOpacity: 0,
            color: '#666',
            opacity: 1,
            width: 0.5,
            weight: 0.5
          }
        }).addTo(map);

        L.geoJson(geoJSON[0], {
          style: styleFeature,
          onEachFeature: function(feature, layer) {

            layer.on({
              click: function() {
                layer.setStyle({
                  color: '#fff',
                  opacity: 1,
                  dashArray: '3',
                  fillOpacity: 1
                });
              },
              mouseover: function(evt) {
                var feature = evt.layer && e.layer.feature;
                info.update(layer.feature.properties.data);
              },
            });
          }
        }).addTo(map);



        var info = L.control();
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        // method that we will use to update the control based on feature properties passed
        info.update = function (props) {
            this._div.innerHTML = '<h4>Australian LGA Population Density</h4>' + 
                (props ? 
                  '<p>Name: <strong>' + props.name + '</strong></p>' + 
                  '<p>Area: <strong>' + props.area + 'km<sup>2</sup></strong></p>' +
                  '<p>Population: <strong>' + props['2012'] + '</strong></p>' +
                  '<p>Population density: <strong>' + props.density + ' people per km<sup>2</sup></strong></p>'
                : '<p>Hover over an LGA</p>');
        };

        info.addTo(map);

        $('#map').css('height', function() { return document.body.clientHeight || '800px'; });
        map.setView([-33.8600, 151.2111], 6);
      });
    </script>
</body>
</html>
