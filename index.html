<!DOCTYPE html>
<html>
<head>
  <title>Australian LGA</title>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>

  <link rel='stylesheet' href='http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css' />
  <link rel='stylesheet' href='style.css' />

  <script src='//cdn.leafletjs.com/leaflet-0.6.4/leaflet.js'></script>
  <script src='//code.jquery.com/jquery-2.0.3.min.js'></script>

  <script src='bower_components/d3/d3.js'></script>
  <script src='bower_components/underscore/underscore.js'></script>
</head>
<body>
  <div id='map'></div>
  <script>
    var cloudmadeUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/22677/256/{z}/{x}/{y}.png'
        cloudmadeAttribution = 'Map data &copy; 2013 OpenStreetMap contributors, Imagery &copy; 2013 CloudMade',
        cloudmade = L.tileLayer(cloudmadeUrl, { 
          maxZoom: 18,
          attribution: cloudmadeAttribution, 
          styleId: 22677
          }),
        formatter = d3.format("0,000"),
        map = L.map('map', {zoom: 6, layers: [cloudmade]}),
        states = ['nsw', 'vic', 'qld', 'sa', 'wa', 'tas', 'nt'],
        geoData = $.getJSON('AUS_LGA.json'),
        nswData = $.getJSON('nsw.json'),
        vicData = $.getJSON('vic.json'),
        qldData = $.getJSON('qld.json'),
        saData = $.getJSON('sa.json'),
        waData = $.getJSON('wa.json'),
        tasData = $.getJSON('tas.json'),
        ntData = $.getJSON('nt.json'),
        stateData = $.getJSON('states.json'),
        seifaData = $.getJSON('lga_seifa.json');

    $.when( geoData, nswData, vicData, qldData, saData, waData, tasData, ntData, stateData, seifaData )
    .done( function( geoJSON, nswJSON, vicJSON, qldJSON, saJSON, waJSON, tasJSON, ntJSON, stateJSON, seifaJSON ) {

      // horrible
      nswJSON[0].forEach(function(l) { 
        geoJSON[0].features.forEach(function(g) {
          if( g.properties.LGA_CODE11 == l.id ) {
            g.properties.data = l;
          }
        });
      });

      vicJSON[0].forEach(function(l) {
        geoJSON[0].features.forEach(function(g) {
          if( g.properties.LGA_CODE11 == l.id ) {
            g.properties.data = l;
          }
        });
      });

      qldJSON[0].forEach(function(l) {
        geoJSON[0].features.forEach(function(g) {
          if( g.properties.LGA_CODE11 == l.id ) {
            g.properties.data = l;
          }
        });
      });

      saJSON[0].forEach(function(l) {
        geoJSON[0].features.forEach(function(g) {
          if( g.properties.LGA_CODE11 == l.id ) {
            g.properties.data = l;
          }
        });
      });

      waJSON[0].forEach(function(l) {
        geoJSON[0].features.forEach(function(g) {
          if( g.properties.LGA_CODE11 == l.id ) {
            g.properties.data = l;
          }
        });
      });

      tasJSON[0].forEach(function(l) {
        geoJSON[0].features.forEach(function(g) {
          if( g.properties.LGA_CODE11 == l.id ) {
            g.properties.data = l;
          }
        });
      });

      ntJSON[0].forEach(function(l) {
        geoJSON[0].features.forEach(function(g) {
          if( g.properties.LGA_CODE11 == l.id ) {
            g.properties.data = l;
          }
        });
      });

      seifaJSON[0].forEach(function(s) {
        geoJSON[0].features.forEach(function(g) {
          if( g.properties.LGA_CODE11 == s.lga_id ) {
            g.properties.seifa = s;
          }
        });
      });

      var allScores = [];
      var numLGAs = geoJSON[0].features.length;

      _.each(geoJSON[0].features, function(f) {
        if( f.properties.seifa ) {
          allScores.push({ lga_id: f.properties.LGA_CODE11, score: f.properties.seifa.score });
        }
      });

      function getColor(d) {
        return d > 1000 ? '#800026' :
               d > 500  ? '#BD0026' :
               d > 200  ? '#E31A1C' :
               d > 100  ? '#FC4E2A' :
               d > 50   ? '#FD8D3C' :
               d > 20   ? '#FEB24C' :
               d > 10   ? '#FED976' :
                          '#FFEDA0';
      };

      function styleFeature(feature) {
        var density = feature.properties.data && feature.properties.data.density ? 
              feature.properties.data.density : 0;

        return {
            fillColor: getColor(density),
            weight: 1,
            opacity: 0.7,
            color: '#888',
            dashArray: '3',
            fillOpacity: 0.7
        };
      };

      function buildHistogram(opts, highlightScore) {
        var scores = _.pluck(opts, 'score'),
            formatCount = d3.format(",.0f"),
            margin = {top: 10, right: 10, bottom: 30, left: 10},
            width = 180 - margin.left - margin.right,
            height = 80 - margin.top - margin.bottom;

        var x = d3.scale.linear()
            .domain([500, 1200])
            .range([0, width + margin.left + margin.right]);

        // Generate a histogram using twenty uniformly-spaced bins.
        var data = d3.layout.histogram()
            .bins(160)
            (scores);

        var binIndex = (function findInBins(bins, value) {
            var index = 0;
            _.each(bins, function(bin, i) {
              if( _.contains(bin, value) ) {
                index = i;
              }
            });
            return index;
        })(data, highlightScore);

        var y = d3.scale.linear()
            .domain([0, d3.max(data, function(d) { return d.y; })])
            .range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .ticks(4)
            .tickSize(4)
            .orient("bottom")

        var svg = d3.select(".hist")
            .append("svg")
            .attr("width", 240)
            .attr("height", 80)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var bar = svg.selectAll(".bar")
            .data(data)
            .enter().append("g")
            .attr("class", function(d, i) { return i === binIndex ? "bar contains-value" : "bar"; })
            .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

        bar.append("rect")
            .attr("x", 1)
            //.attr("width", x(data[0].dx))
            .attr("width", 1)
            .attr("height", function(d) { return height - y(d.y); });

        bar.append("text")
            .attr("dy", ".55em")
            .attr("y", 6)
            //.attr("x", x(data[0].dx) / 2)
            .attr("text-anchor", "middle")
            //.text(function(d) { return d.y; });

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);
      };

      function buildGraph(opts) {
        var data = opts.data,
            el = opts.el,
            margin = {top: 30, right: 45, bottom: 30, left: 45}, 
            width = 280 - margin.left - margin.right,
            height = 120 - margin.top - margin.bottom;

        // convert to a timestamp so we can use a time scale
        data.forEach(function(d) {
          d.year = (new Date(d.year)).getTime();
        });

        var x = d3.time.scale()
                  .domain([data[0].year, data[data.length-1].year])
                  .range([0, width]);
            y = d3.scale.linear()
                  .domain([d3.min(data, function(d) { return +d.pop }), d3.max(data, function(d) { return +d.pop; })])
                  .range([height, 0]),

            xAxis = d3.svg.axis().scale(x)
              .orient("bottom")
              .tickFormat(d3.time.format('%y'))
              .tickSize(3)
              .ticks(data.length),

            yAxis = d3.svg.axis().scale(y)
              .orient("left")
              .tickSize(3)
              .tickValues(y.domain()),

            area = d3.svg.area()
              .interpolate("monotone")
              .x(function(d) { return x(d.year); })
              .y0(height)
              .y1(function(d) { return y(d.pop); }),

            valueline = d3.svg.line()
              .x(function(d) { return x(d.year); }) 
              .y(function(d) { return y(d.pop); }),

            svg = d3.select('.graph')
              .append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Add the clip path.
        svg.append("clipPath")
            .attr("id", "clip")
          .append("rect")
            .attr("width", width)
            .attr("height", height);

        // Add the area path.
        // http://bl.ocks.org/mbostock/1166403
        /*svg.append("path")
            .attr("class", "area")
            .attr("clip-path", "url(#clip)")
            .attr("d", area(data));
        */

        svg.append("path") // Add the valueline path.
            .attr("d", valueline(data));

        svg.append("g") // Add the X Axis
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);
      };

      // -- Add GeoJSON layer to map
      L.geoJson(stateJSON[0], {
        style: {
          fillColor: 'transparent',
          fillOpacity: 0,
          color: '#999',
          opacity: 1,
          width: 0.5,
          weight: 0.5
        }
      }).addTo(map);

      L.geoJson(geoJSON[0], {
        style: styleFeature,
        onEachFeature: function(feature, layer) {

          layer.on({
            click: function() {
              layer.setStyle({
                color: '#fff',
                opacity: 1,
                dashArray: '3',
                fillOpacity: 1
              });
            },
            mouseover: function(evt) {
              var feature = evt.layer && evt.layer.feature;
              info.update(layer.feature.properties);
            },
            mouseout: function(evt) {
              //info.update();
            }
          });
        }
      }).addTo(map);


      // -- Add the Info box
      var info = L.control();
      info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
      };

      info.update = function(props) {

        if( !props ) {
          this._div.innerHTML = '<p>Hover over an LGA</p>';
        }
        else {
          var numLGAInState = { 
            'NSW': 154,
            'QLD': 74,
            'VIC': 79,
            'WA': 142,
            'SA': 64,
            'NT': 21,
            'TAS': 30
          };

          var lgaName = props.data.name.replace(/(\(*.\))/, '');

          this._div.innerHTML = 
            '<h5 class="lga-name">' + lgaName + '</h5>' + 
            '<span class="state">' + props.seifa.state.toUpperCase() + '</span>' + 
            
            '<h6>Area</h6>' + 
            '<span class="value">' + formatter(props.data.area) + '</span><span class="units">km<sup>2</sup></span>' +
            
            '<h6>2012 Population</h6>' +
            '<span class="value">' + formatter(props.data['2012']) + '</span>' +
            
            '<h6>Population Density</h6>' + 
            '<span class="value">' + props.data.density + ' </span><span class="units">people per km<sup>2</sup></span>' +

            '<div class="graph"></div>' +
            
            '<hr>' + 

            '<h5 class="seifa-header">Socio-economic (SEIFA)</h5>' + 
            '<div class="seifa-container">' + 
            '<strong class="seifa-score">' + formatter(props.seifa.score) + '</strong>' + 
            '<div class="hist"></div>' + 
            '</div>' +

            '<div class="rank-container">' + 
              '<div class="rank">' +
                '<h4>National</h4>' + 
                '<span class="rank-value">' + (numLGAs - parseInt(props.seifa.national_rank, 10)) + '</span>' +
                '<span class="total-lgas"> /' + numLGAs + '</span>' +
                '<div class="percentile">' + props.seifa.national_percentile + ' percentile</div>' +
              '</div>' + 

              '<div class="rank">' +
                '<h4>State</h4>' + 
                '<span class="rank-value">' + (numLGAInState[props.seifa.state.toUpperCase()] - parseInt(props.seifa.state_rank, 10)) + '</span>' +
                '<span class="total-lgas"> /' + numLGAInState[props.seifa.state.toUpperCase()] + '</span>' +
                '<div class="percentile">' + props.seifa.state_percentile + ' percentile</div>' +
              '</div>' + 
            '</div>' + 

            '<a target="_blank" href="http://en.wikipedia.org/wiki/SEIFA">More on SEIFA</a>';

          var graphData = (function(obj) {
              var d = [];
              // get Years
              for( p in obj ) {
                if( /^\d{4}$/.test(p) ) {
                  d.push({year: p, pop: obj[p] });
                }
              }
              return d;
            })(props.data);
          
          buildGraph({data: graphData, el: 'graph'});

          // pass in all scores, plus this LGA score to highlight
          buildHistogram(allScores, props.seifa.score);
        }
      };
      info.addTo(map);

      // --- Search control
      var search = L.control();
      search.onAdd = function(map) {
        this._div = L.DomUtil.create('div', 'search');
        this.update();
        return this._div;
      };
      search.update = function(props) {
        this._div.innerHTML = '<h4>Search</h4>' + 
          '<input id="search" type="search" value="" placeholder="search" class="topcoat-search-input--large">';
      };
      search.addTo(map);

      // --- Legend control
      var legend = L.control();
      legend.onAdd = function (map) {
          var div = L.DomUtil.create('div', 'info legend'),
              grades = [0, 10, 20, 50, 100, 200, 500, 1000],
              labels = [];

          // loop through our density intervals and generate a label with a colored square for each interval
          for (var i = 0; i < grades.length; i++) {
              div.innerHTML +=
                  '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                  grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
          }
          return div;
      };
      legend.addTo(map);

      $('#map').css('height', function() { return document.body.clientHeight || '800px'; });
      map.setView([-33.8600, 151.2111], 6);
    });
  </script>
</body>
</html>
